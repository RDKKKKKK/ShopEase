name: Microservices CI/CD

on:
  push:
    branches:
      - master

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services-changed: ${{ steps.changed-services.outputs.changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Detect changed services
        id: changed-services
        run: |
          # 获取变更文件
          CHANGED_FILES=$(git diff --name-only origin/master)
          echo "Changed files: $CHANGED_FILES"

          # 定义微服务目录
          services=("newbee-mall-cloud-shop-cart-service" 
                    "newbee-mall-cloud-shop-cart-api" 
                    "newbee-mall-cloud-shop-cart-web"
                    "newbee-mall-cloud-gateway-admin"
                    "newbee-mall-cloud-goods-service"
                    "newbee-mall-cloud-order-service")

          # 初始化一个空数组存放有变更的服务
          changed_services=()
          
          # 检查变更文件是否属于某个服务
          for service in "${services[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "$service/"; then
              changed_services+=("$service")
            fi
          done
          
          # 如果没有检测到变更的服务，给一个默认值（空服务）
          if [ ${#changed_services[@]} -eq 0 ]; then
            changed_services+=("no-changes")
          fi

          # 输出变更的服务，作为 JSON 字符串
          echo "Changed services: ${changed_services[@]}"
          echo "::set-output name=changed::$(echo ${changed_services[@]} | jq -R -s -c 'split(" ")')"

  build-and-push:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services-changed) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Build and push Docker image
        if: matrix.service != 'no-changes'
        run: |
          # 去掉 'newbee-mall-cloud' 前缀，并根据服务名称调整镜像命名
          IMAGE_NAME=$(echo ${{ matrix.service }} | sed 's/newbee-mall-cloud-//')
          
          # 构建变更的服务镜像并推送到 DockerHub
          docker build -t roderickyoung/shopease:${IMAGE_NAME}-1.0.0 ./newbee-mall-cloud/${{ matrix.service }}
          
          # 推送到 DockerHub
          docker push roderickyoung/shopease:${IMAGE_NAME}-1.0.0